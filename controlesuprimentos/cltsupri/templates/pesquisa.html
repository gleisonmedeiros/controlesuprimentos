{% extends 'index.html' %}
{% load static %}

{% block content %}

<h5>Consulta de Entregas por Unidade</h5>

<form method="GET" id="filter-form" class="mb-4">

    <!-- PROJETO -->
    <div class="row mb-3">
        <div class="col-md-6">
            <label>Projeto</label>
            <select name="projeto" id="id_projeto" class="form-control">
                <option value="">Selecione um Projeto</option>
                {% for projeto in form_projeto %}
                    <option value="{{ projeto.id }}"
                        {% if projeto_id == projeto.id|stringformat:"s" %}selected{% endif %}>
                        {{ projeto.nome }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- UNIDADE -->
        <div class="col-md-6">
            <label>Unidade</label>
            <select name="unidade" id="id_unidade" class="form-control select2-field"
                    {% if not projeto_id %}disabled{% endif %}>
                <option value="">Selecione uma Unidade</option>
                {% for unidade in form_unidades %}
                    <option value="{{ unidade.id }}"
                        {% if unidade_id == unidade.id|stringformat:"s" %}selected{% endif %}>
                        {{ unidade.nome }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Datas -->
    <div class="row mb-3">
        <div class="col-md-6">
            <label>Data Início</label>
            <input type="date" name="data_inicio" class="form-control" value="{{ data_inicio }}">
        </div>

        <div class="col-md-6">
            <label>Data Fim</label>
            <input type="date" name="data_fim" class="form-control" value="{{ data_fim }}">
        </div>
    </div>

    <button class="btn btn-primary mt-2">Pesquisar</button>

</form>

<hr>

<!-- TABELA -->
<table class="table table-striped table-hover">
    <thead class="table-dark">
        <tr>
            <th>#</th>
            <th>Unidade</th>
            <th>Suprimento</th>
            <th>Quantidade</th>
            <th>Data</th>
        </tr>
    </thead>

    <tbody>
        {% for entrega in form %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ entrega.unidade.nome }}</td>
                <td>{{ entrega.suprimento.nome }}</td>
                <td>{{ entrega.quantidade_entregue }}</td>
                <td>{{ entrega.data }}</td>
            </tr>
        {% empty %}
            <tr><td colspan="5">Nenhuma entrega encontrada.</td></tr>
        {% endfor %}
    </tbody>
</table>


<!-- AUTO-SUBMIT PROJETO -->
<script>
document.getElementById('id_projeto').addEventListener('change', function() {
    document.getElementById('filter-form').submit();
});
</script>


<!-- SELECT2 LIBS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


<!-- SELECT2 FIX: ABRIR COM FOCO NO SEARCH -->
<script>
$(document).ready(function() {

    {% if projeto_id %}
        $('#id_unidade').prop('disabled', false);
    {% endif %}

    // Delay evita conflito com o Bootstrap e garante renderização total
    setTimeout(function () {
        $('#id_unidade').select2({
            placeholder: "Pesquise uma Unidade...",
            allowClear: true,
            width: '100%'
        });

        // Forçar foco no campo de pesquisa ao abrir
        $('#id_unidade').on('select2:open', function() {
            document.querySelector('.select2-container--open .select2-search__field').focus();
        });

    }, 10);
});
</script>


<style>
/* Melhorar aparência */
.select2-container .select2-selection--single {
    height: 38px !important;
    border: 1px solid #ced4da !important;
    border-radius: 0.375rem !important;
}

.select2-selection__rendered {
    line-height: 36px !important;
}

.select2-selection__arrow {
    height: 36px !important;
}
</style>

{% endblock %}
