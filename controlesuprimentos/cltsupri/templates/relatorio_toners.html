{% extends 'index.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h4>Relação de toners entregues</h4>

  <form method="GET" id="filter-form" class="row g-3 mb-4">

    <!-- Projeto -->
    <div class="col-md-3">
      <label for="projeto" class="form-label">Projeto</label>
      <select name="projeto" id="projeto" class="form-control">
        <option value="">Todos</option>
        {% for projeto in projetos %}
          <option value="{{ projeto.id }}" {% if projeto.id|stringformat:"s" == projeto_id %}selected{% endif %}>
            {{ projeto.nome }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Unidade (ESTA É A SUA COMBO ORIGINAL) -->
    <div class="col-md-3">
      <label>Unidade</label>
      <select name="unidade" id="id_unidade" class="form-control select2-field"
              {% if not projeto_id %}disabled{% endif %}>
        <option value="">Selecione uma Unidade</option>
        {% for unidade in unidades %}
          {% if not projeto_id or unidade.projeto.id|stringformat:"s" == projeto_id %}
            <option value="{{ unidade.id }}"
                {% if unidade.id|stringformat:"s" == unidade_id %}selected{% endif %}>
              {{ unidade.nome }}
            </option>
          {% endif %}
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label for="data_inicio" class="form-label">Data Inicial</label>
      <input type="date" class="form-control" id="data_inicio" name="data_inicio" value="{{ data_inicio }}">
    </div>

    <div class="col-md-3">
      <label for="data_fim" class="form-label">Data Final</label>
      <input type="date" class="form-control" id="data_fim" name="data_fim" value="{{ data_fim }}">
    </div>

    <div class="col-12 d-flex justify-content-end">
      <button type="submit" class="btn btn-primary">Filtrar</button>
    </div>
  </form>

  <!-- Tabela -->
  {% if entregas %}
    <table class="table table-striped table-hover mt-3">
      <thead class="table-light">
        <tr>
          <th>Suprimento</th>
          <th>Total Entregue</th>
        </tr>
      </thead>
      <tbody>
        {% for e in entregas %}
          <tr>
            <td>{{ e.suprimento__nome }}</td>
            <td>{{ e.total }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
</div>

<!-- AUTO-SUBMIT PROJETO -->
<script>
document.getElementById('projeto').addEventListener('change', function() {
    document.getElementById('filter-form').submit();
});
</script>

<!-- SELECT2 LIBS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- FILTRO DINÂMICO COM SELECT2 SEM QUEBRAR A CAIXA -->
<script>
const projetoSelect = document.getElementById('projeto');
const unidadeSelect = document.getElementById('id_unidade');
const unidadeSelecionada = "{{ unidade_id }}";

// Todas as unidades
const todasUnidades = [
    {% for unidade in unidades %}
      {id: "{{ unidade.id }}", nome: "{{ unidade.nome }}", projeto_id: "{{ unidade.projeto.id }}"},
    {% endfor %}
];

function carregarUnidades() {
    const projetoId = projetoSelect.value;

    // limpando SEM quebrar Select2
    $('#id_unidade').empty();

    // adiciona padrão
    $('#id_unidade').append(new Option("Selecione uma Unidade", "", false, false));

    // adiciona filtradas
    todasUnidades.forEach(u => {
        if (!projetoId || u.projeto_id === projetoId) {
            const option = new Option(
                u.nome,
                u.id,
                false,
                u.id === unidadeSelecionada
            );
            $('#id_unidade').append(option);
        }
    });

    // atualiza Select2
    $('#id_unidade').trigger('change');

    // desabilita se sem projeto
    $('#id_unidade').prop('disabled', !projetoId);
}

$(document).ready(function() {

    carregarUnidades(); // popula ao carregar

    // Inicializa Select2 com sua configuração original
    setTimeout(function () {
        $('#id_unidade').select2({
            placeholder: "Pesquise uma Unidade...",
            allowClear: true,
            width: '100%'
        });

        $('#id_unidade').on('select2:open', function() {
            document.querySelector('.select2-container--open .select2-search__field').focus();
        });

    }, 10);

    // Auto-filtro ao mudar projeto
    $('#projeto').on('change', function() {
        carregarUnidades();
    });

});
</script>

<style>
.select2-container .select2-selection--single {
    height: 38px !important;
    border: 1px solid #ced4da !important;
    border-radius: 0.375rem !important;
}
.select2-selection__rendered {
    line-height: 36px !important;
}
.select2-selection__arrow {
    height: 36px !important;
}
</style>

{% endblock %}
