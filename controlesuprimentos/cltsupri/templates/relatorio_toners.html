{% extends 'index.html' %}

{% block content %}
<div class="container mt-4">
  <h3>Relação de Toners Entregues</h3>

  <!-- Formulário de filtros -->
  <form method="GET" class="row g-3 mb-4">

    <!-- Projeto -->
    <div class="col-md-3">
      <label for="projeto" class="form-label">Projeto</label>
      <select name="projeto" id="projeto" class="form-control">
        <option value="">Todos</option>
        {% for projeto in projetos %}
          <option value="{{ projeto.id }}" {% if projeto.id|stringformat:"s" == projeto_id %}selected{% endif %}>
            {{ projeto.nome }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Unidade -->
    <div class="col-md-3">
      <label for="unidade" class="form-label">Unidade</label>
      <select name="unidade" id="unidade" class="form-control">
        <option value="">Todas</option>
        {% for unidade in unidades %}
          {% if not projeto_id or unidade.projeto.id|stringformat:"s" == projeto_id %}
            <option value="{{ unidade.id }}" {% if unidade.id|stringformat:"s" == unidade_id %}selected{% endif %}>
              {{ unidade.nome }}
            </option>
          {% endif %}
        {% endfor %}
      </select>
    </div>

    <!-- Data Inicial -->
    <div class="col-md-3">
      <label for="data_inicio" class="form-label">Data Inicial</label>
      <input type="date" class="form-control" id="data_inicio" name="data_inicio" value="{{ data_inicio }}">
    </div>

    <!-- Data Final -->
    <div class="col-md-3">
      <label for="data_fim" class="form-label">Data Final</label>
      <input type="date" class="form-control" id="data_fim" name="data_fim" value="{{ data_fim }}">
    </div>

    <!-- Botão de filtro -->
    <div class="col-12 d-flex justify-content-end">
      <button type="submit" class="btn btn-primary">Filtrar</button>
    </div>
  </form>

  <!-- Tabela de resultados -->
  {% if entregas %}
    <table class="table table-striped table-hover mt-3">
      <thead class="table-light">
        <tr>
          <th>Suprimento</th>
          <th>Total Entregue</th>
        </tr>
      </thead>
      <tbody>
        {% for e in entregas %}
          <tr>
            <td>{{ e.suprimento__nome }}</td>
            <td>{{ e.total }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% elif data_inicio or data_fim or projeto_id or unidade_id %}
    <div class="alert alert-warning mt-3">
      Nenhum toner entregue no período ou filtros selecionados.
    </div>
  {% endif %}
</div>

<!-- JavaScript para filtrar unidades dinamicamente -->
<script>
  const projetoSelect = document.getElementById('projeto');
  const unidadeSelect = document.getElementById('unidade');

  // Armazena todas as unidades em um objeto JS
  const todasUnidades = [
    {% for unidade in unidades %}
      {id: '{{ unidade.id }}', nome: '{{ unidade.nome }}', projeto_id: '{{ unidade.projeto.id }}'},
    {% endfor %}
  ];

  projetoSelect.addEventListener('change', () => {
    const projetoId = projetoSelect.value;
    unidadeSelect.innerHTML = '<option value="">Todas</option>';

    todasUnidades.forEach(u => {
      if (!projetoId || u.projeto_id === projetoId) {
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = u.nome;
        unidadeSelect.appendChild(opt);
      }
    });
  });
</script>
{% endblock %}

